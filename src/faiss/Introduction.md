# Introduction

## Product Quantizer

### Pretrain
- Clustering：

    以128维向量为例，首先指定一个参数M（例如4），表示将向量切分成M段。这样N个向量都被切成了4段的32维向量，以第一段的N个32维向量为例，做 Clustering 得到K个簇心（例如256，经验值）。
- Assign：

    把每一段的向量分配到最近的簇心，得到一个4维的索引，例如[0, 255, 78, 183]。

这样就完成了向量的压缩。

### Query
对于每一个查询向量，以相同的方法把128维分成4段32维向量，然后计算每一段向量与之前预训练好的簇心的距离，得到一个4*256的表。

所以在计算时只用查M次表，比如的库里的某个向量被量化成了[0, 255, 78, 183], 那么首先查表得到查询向量第一段子向量与其ID为0的簇心的距离，然后再查表得到查询向量第二段子向量与其ID为255的簇心的距离......最后就可以得到四个距离d1、d2、d3、d4，查询向量跟库里向量的距离d = d1+d2+d3+d4。

## Inverted File System
为了避免在全空间中进行遍历，可以将向量空间划分为多个子空间，这样，在搜索的时候，通过某种方式，快速锁定在某一（几）子空间，然后在该（几个）子空间里做遍历。

每来一个query向量，首先计算其与256个粗聚类簇心的距离，然后选择距离最近的top K个簇，只计算查询向量与这几个簇底下的向量的距离，计算距离的方法就是前面说的PQ。在计算查询向量和一个簇底下的向量的距离的时候，所有向量都会被转化成与簇心的残差。

> [搜索召回 | Facebook: 亿级向量相似度检索库Faiss原理+应用](https://zhuanlan.zhihu.com/p/432317877)